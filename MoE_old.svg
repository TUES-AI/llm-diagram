<svg viewBox="0 0 1000 700" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
    <marker id="gating_arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#9013FE" />
    </marker>

    <linearGradient id="expertGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#4A90E2;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#357ABD;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="expertGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#7ED321;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#6BAE1A;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="expertGrad3" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#F5A623;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D1901C;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="expertGrad4" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#D0021B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#B40115;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="gateGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#9013FE;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7B1FA2;stop-opacity:1" />
    </linearGradient>
  </defs>

  <!-- MoE Layer Background -->
  <rect x="50" y="50" width="900" height="600" rx="15" fill="#F8F8FF" stroke="#8A2BE2" stroke-width="3"/>
  <text x="500" y="85" text-anchor="middle" font-size="20" font-weight="bold" fill="#8A2BE2">Mixture of Experts (MoE) Layer</text>

  <!-- Step numbers -->
  <circle cx="80" cy="150" r="15" fill="#333" stroke="white" stroke-width="2"/>
  <text x="80" y="155" text-anchor="middle" font-size="12" font-weight="bold" fill="white">1</text>

  <circle cx="80" cy="250" r="15" fill="#333" stroke="white" stroke-width="2"/>
  <text x="80" y="255" text-anchor="middle" font-size="12" font-weight="bold" fill="white">2</text>

  <circle cx="80" cy="400" r="15" fill="#333" stroke="white" stroke-width="2"/>
  <text x="80" y="405" text-anchor="middle" font-size="12" font-weight="bold" fill="white">3</text>

  <circle cx="80" cy="550" r="15" fill="#333" stroke="white" stroke-width="2"/>
  <text x="80" y="555" text-anchor="middle" font-size="12" font-weight="bold" fill="white">4</text>

  <!-- Input -->
  <rect x="120" y="120" width="120" height="60" rx="8" fill="#E6F3FF" stroke="#4A90E2" stroke-width="2"/>
  <text x="180" y="145" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">Input</text>
  <text x="180" y="165" text-anchor="middle" font-size="12" fill="#666">[seq_len, d_model]</text>

  <!-- Arrow from input splits -->
  <path d="M 240 150 L 300 150" stroke="#333" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

  <!-- Split point -->
  <circle cx="320" cy="150" r="8" fill="#333"/>

  <!-- Arrow down to gating -->
  <path d="M 320 158 L 320 220" stroke="#333" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

  <!-- Arrow right to experts (broadcast) -->
  <path d="M 328 150 L 400 150" stroke="#333" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>
  <text x="324" y="115" text-anchor="middle" font-size="16" fill="#999">broadcast to all experts</text>

  <!-- Gating Network / Router -->
  <rect x="250" y="230" width="140" height="80" rx="8" fill="url(#gateGrad)" stroke="#666" stroke-width="2"/>
  <text x="320" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Router/Gating</text>
  <text x="320" y="268" text-anchor="middle" font-size="12" fill="white">Linear + Softmax</text>
  <text x="320" y="285" text-anchor="middle" font-size="11" fill="rgba(255,255,255,0.8)">Top-K Selection</text>
  <text x="320" y="300" text-anchor="middle" font-size="10" fill="rgba(255,255,255,0.7)">Outputs: weights + indices</text>

  <!-- Expert row (top, unchanged visuals) -->
  <!-- Expert 1 (top) -->
  <g>
    <rect x="450" y="100" width="100" height="100" rx="8" fill="url(#expertGrad1)" stroke="#666" stroke-width="2"/>
    <text x="500" y="125" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Expert 1</text>
    <rect x="460" y="135" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="500" y="145" text-anchor="middle" font-size="9" fill="white">Linear(d→4d)</text>
    <rect x="460" y="155" width="80" height="12" rx="2" fill="rgba(255,255,255,0.2)"/>
    <text x="500" y="163" text-anchor="middle" font-size="8" fill="white">ReLU/GELU</text>
    <rect x="460" y="172" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="500" y="182" text-anchor="middle" font-size="9" fill="white">Linear(4d→d)</text>
  </g>

  <!-- Expert 2 (top) -->
  <g>
    <rect x="570" y="100" width="100" height="100" rx="8" fill="url(#expertGrad2)" stroke="#666" stroke-width="2"/>
    <text x="620" y="125" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Expert 2</text>
    <rect x="580" y="135" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="620" y="145" text-anchor="middle" font-size="9" fill="white">Linear(d→4d)</text>
    <rect x="580" y="155" width="80" height="12" rx="2" fill="rgba(255,255,255,0.2)"/>
    <text x="620" y="163" text-anchor="middle" font-size="8" fill="white">ReLU/GELU</text>
    <rect x="580" y="172" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="620" y="182" text-anchor="middle" font-size="9" fill="white">Linear(4d→d)</text>
  </g>

  <!-- Expert 3 (top) -->
  <g>
    <rect x="690" y="100" width="100" height="100" rx="8" fill="url(#expertGrad3)" stroke="#666" stroke-width="2"/>
    <text x="740" y="125" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Expert 3</text>
    <rect x="700" y="135" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="740" y="145" text-anchor="middle" font-size="9" fill="white">Linear(d→4d)</text>
    <rect x="700" y="155" width="80" height="12" rx="2" fill="rgba(255,255,255,0.2)"/>
    <text x="740" y="163" text-anchor="middle" font-size="8" fill="white">ReLU/GELU</text>
    <rect x="700" y="172" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="740" y="182" text-anchor="middle" font-size="9" fill="white">Linear(4d→d)</text>
  </g>

  <!-- Expert 4 (top) -->
  <g>
    <rect x="810" y="100" width="100" height="100" rx="8" fill="url(#expertGrad4)" stroke="#666" stroke-width="2"/>
    <text x="860" y="125" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Expert 4</text>
    <rect x="820" y="135" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="860" y="145" text-anchor="middle" font-size="9" fill="white">Linear(d→4d)</text>
    <rect x="820" y="155" width="80" height="12" rx="2" fill="rgba(255,255,255,0.2)"/>
    <text x="860" y="163" text-anchor="middle" font-size="8" fill="white">ReLU/GELU</text>
    <rect x="820" y="172" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="860" y="182" text-anchor="middle" font-size="9" fill="white">Linear(4d→d)</text>
  </g>

  <!-- Crossed out experts (not selected) remain -->
  <line x1="690" y1="100" x2="790" y2="200" stroke="red" stroke-width="4" opacity="0.7"/>
  <line x1="790" y1="100" x2="690" y2="200" stroke="red" stroke-width="4" opacity="0.7"/>
  <text x="740" y="220" text-anchor="middle" font-size="11" fill="red" font-weight="bold">w₃ = 0.0 (not selected)</text>

  <line x1="810" y1="100" x2="910" y2="200" stroke="red" stroke-width="4" opacity="0.7"/>
  <line x1="910" y1="100" x2="810" y2="200" stroke="red" stroke-width="4" opacity="0.7"/>
  <text x="860" y="220" text-anchor="middle" font-size="11" fill="red" font-weight="bold">w₄ = 0.0 (not selected)</text>

  <!-- SECOND ROW: copies of Expert 1 and Expert 2 -->
  <!-- Expert 1 copy (second row) -->
  <g>
	<rect x="450" y="230" width="100" height="100" rx="8" fill="url(#expertGrad1)" stroke="#666" stroke-width="2"/>
	<text x="500" y="260" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Expert 1</text>
	<rect x="460" y="270" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
	<text x="500" y="280" text-anchor="middle" font-size="9" fill="white">Linear(d→4d)</text>
	<rect x="460" y="290" width="80" height="12" rx="2" fill="rgba(255,255,255,0.2)"/>
	<text x="500" y="298" text-anchor="middle" font-size="8" fill="white">ReLU/GELU</text>
	<rect x="460" y="307" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
	<text x="500" y="317" text-anchor="middle" font-size="9" fill="white">Linear(4d→d)</text>

  </g>

  <!-- Expert 2 copy (second row) -->
  <g>
    <rect x="570" y="230" width="100" height="100" rx="8" fill="url(#expertGrad2)" stroke="#666" stroke-width="2"/>
    <text x="620" y="260" text-anchor="middle" font-size="13" font-weight="bold" fill="white">Expert 2</text>
    <rect x="580" y="270" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="620" y="280" text-anchor="middle" font-size="9" fill="white">Linear(d→4d)</text>
    <rect x="580" y="290" width="80" height="12" rx="2" fill="rgba(255,255,255,0.2)"/>
    <text x="620" y="298" text-anchor="middle" font-size="8" fill="white">ReLU/GELU</text>
    <rect x="580" y="307" width="80" height="15" rx="2" fill="rgba(255,255,255,0.3)"/>
    <text x="620" y="317" text-anchor="middle" font-size="9" fill="white">Linear(4d→d)</text>
  </g>

  <!-- <circle cx="320" cy="330" r="5" fill="#9013FE"/> -->
  <text x="345" y="325" font-size="12" font-weight="bold" fill="#9013FE">weight 0.3</text>
  <text x="345" y="340" font-size="11" fill="#9013FE">(chooses)</text>

  <!-- Router weights to combination: go down then right -->
  <path d="M 320 310 L 320 410 L 400 410" stroke="#9013FE" stroke-width="2.5" fill="none" marker-end="url(#gating_arrow)"/>
  <text x="330" y="395" text-anchor="start" font-size="11" font-weight="bold" fill="#9013FE">weights</text>

  <!-- Weighted Combination -->
  <rect x="400" y="410" width="200" height="80" rx="8" fill="#FFE6CC" stroke="#F5A623" stroke-width="2"/>
  <text x="500" y="435" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">Weighted Combination</text>
  <text x="500" y="455" text-anchor="middle" font-size="12" fill="#333">Router weights × Expert outputs</text>
  <text x="500" y="473" text-anchor="middle" font-size="11" fill="#333">0.7 × Output₁ + 0.3 × Output₂</text>
  <text x="500" y="485" text-anchor="middle" font-size="10" fill="#666">[seq_len, d_model]</text>

  <!-- Expert outputs from second row to combination -->
  <!-- <path d="M 500 400 L 500 410" stroke="#4A90E2" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/> -->
  <!-- <text x="485" y="395" text-anchor="end" font-size="11" fill="#4A90E2">Output₁</text> -->

  <!-- <path d="M 620 400 L 620 410 L 600 410" stroke="#7ED321" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/> -->
  <!-- <text x="625" y="395" text-anchor="start" font-size="11" fill="#7ED321">Output₂</text> -->

  <!-- Final output arrow -->
  <path d="M 500 490 L 500 530" stroke="#333" stroke-width="3" fill="none" marker-end="url(#arrowhead)"/>

  <!-- Output -->
  <rect x="420" y="540" width="160" height="60" rx="8" fill="#E6FFE6" stroke="#4CAF50" stroke-width="2"/>
  <text x="500" y="565" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">MoE Output</text>
  <text x="500" y="585" text-anchor="middle" font-size="12" fill="#666">[seq_len, d_model]</text>

  <!-- Legend/Notes -->
  <g transform="translate(650, 350)">
    <rect x="0" y="0" width="280" height="180" rx="8" fill="rgba(255,255,255,0.9)" stroke="#ccc" stroke-width="1"/>
    <text x="140" y="25" text-anchor="middle" font-size="14" font-weight="bold" fill="#333">Key Points:</text>
    <text x="20" y="50" font-size="12" fill="#333">• Router selects top-K experts</text>
    <text x="20" y="70" font-size="12" fill="#333">• Router provides mixing weights</text>
    <text x="20" y="90" font-size="12" fill="#333">• Only selected experts compute</text>
    <text x="20" y="110" font-size="12" fill="#333">• Weights × outputs combined</text>
    <text x="20" y="130" font-size="12" fill="#333">• Same input dimension maintained</text>
    <text x="20" y="160" font-size="11" font-style="italic" fill="#666">Each expert is a standard FFN</text>
  </g>
</svg>

